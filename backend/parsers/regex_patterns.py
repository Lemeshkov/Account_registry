import re

# -------------------------------------------------
# META
# -------------------------------------------------

INVOICE_NUMBER_DATE = (
    r"сч[её]т\s*(?:на\s*оплату\s*)?"
    r"(?:№|N)?\s*([\w\-\/]+)\s*"
    r"(?:от|oт)\s*([0-9]{1,2}\s+[а-яА-Я]+\s+[0-9]{4})"
)

INN = r"\bИНН\s*[:№]?\s*(\d{10,12})\b"

ACCOUNT = r"(?:р\/?с|сч\.?\s*№?)\s*[:№]?\s*(\d{20})"

TOTAL = r"(?:итого|всего\s*к\s*оплате)\s*[:=]?\s*([\d\s.,]+)"

VAT = r"(?:ндс\s*\(?\d+%?\)?)[^\d]*([\d\s.,\-]+)"


# -------------------------------------------------
INVOICE_LINE_RE = r"""
(?<!\d\.)                     # Не начинается с цифры с точкой (не перепутать с дробями)
(\d{1,3})                     # № позиции (1-3 цифры)
[\s\-\.]+                     # Разделитель
(.+?)                         # Описание (жадный минимальный)
\s+
(\d{1,4}(?:[,\\.]\d{1,3})?)   # Количество (может быть дробным)
\s*
(?:шт|ш[тt]|uт|ut|шt|wt)?    # Единицы измерения (с вариантами OCR)
\s*
([\d\s]+[,\\.]\d{2})          # Цена (с пробелами и 2 знаками после запятой)
\s+
([\d\s]+[,\\.]\d{2})          # Сумма (с пробелами и 2 знаками после запятой)
"""

# Альтернативный упрощенный паттерн для fallback
INVOICE_LINE_SIMPLE_RE = r"""
^(\d{1,3})                    # Номер строки
[\s\.\-]+                     # Разделители
([^\n]{10,200}?)             # Описание (от 10 до 200 символов)
\s+
(\d+(?:[,\\.]\d+)?)          # Количество
\s+
([\d\s]+[,\\.]\d{2})         # Цена
\s+
([\d\s]+[,\\.]\d{2})         # Сумма
"""

# Паттерн для поиска строк в свободном формате
FREEFORM_LINE_RE = r"""
(\d{1,3})                     # Номер
\s+
(.+?)                         # Описание
\s+
(?:
    (?:кол-во|количество|кол|к-во)\s*[:=]?\s*(\d+(?:[,\\.]\d+)?)\s*|
    (\d+(?:[,\\.]\d+)?)\s*(?:шт|ш[тt]|uт|ut)?\s*
)
([\d\s]+[,\\.]\d{2})          # Цена
\s+
([\d\s]+[,\\.]\d{2})          # Сумма
"""

PRICE_SUM_RE = r"([\d\s]+[.,]\d{2})\s*([\d\s]+[.,]\d{2})"

# # # backend/parsers/regex_patterns.py


# # -------------------------------------------------
# # META
# # -------------------------------------------------

# INVOICE_NUMBER_DATE = (
#     r"сч[её]т\s*(?:на\s*оплату\s*)?"
#     r"(?:№|N)?\s*([\w\-\/]+)\s*"
#     r"(?:от|oт)\s*([0-9]{1,2}\s+[а-яА-Я]+\s+[0-9]{4})"
# )

# SUPPLIER_RE = r"(?:поставщик|исполнитель)\s*[:\-]?\s*(.+?)(?:\s+ИНН|$|\n)"

# INN = r"\bИНН\s*[:№]?\s*(\d{10,12})\b"

# ACCOUNT = r"(?:р\/?с|сч\.?\s*№?)\s*[:№]?\s*(\d{20})"

# TOTAL = r"(?:итого|всего\s*к\s*оплате)\s*[:=]?\s*([\d\s.,]+)"

# VAT = r"(?:ндс\s*\(?\d+%?\)?)[^\d]*([\d\s.,\-]+)"

# INVOICE_NUMBER_RE = r"сч[её]т\s*№?\s*([A-ZА-Я0-9\-\/]+)"
# INVOICE_DATE_RE = r"от\s*(\d{1,2}\s+[а-яё]+\s+\d{4})"


# # -------------------------------------------------
# # LINES
# # -------------------------------------------------

# INVOICE_LINE_RE = r"""
# (?<!\d)
# (\d{1,2})                       # № позиции
# \s+
# (.+?)                           # описание
# \s+
# (\d{1,3})                       # количество
# \s*
# (?:шт|uт|ut|шt|wt)?              # единица (OCR-варианты)
# \s*
# ([\d\s]+[,.]\d{2})              # цена
# \s+
# ([\d\s]+[,.]\d{2})              # сумма
# (?=\s+\d{1,2}\s+|$)
# """

# PRICE_SUM_RE = r"([\d\s]+[,.]\d{2})\s*([\d\s]+[,.]\d{2})"




